<div class="policy-acknowledgments-container">
  <div class="page-header">
    <h2>Policy Acknowledgments</h2>
    <p class="subtitle">Track and manage policy acknowledgment compliance</p>
  </div>

  <div class="content-section">
    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading">
      <div class="loading-spinner">
        <i class="dx-icon-loading"></i>
      </div>
      <p>Loading policy statistics...</p>
    </div>

    <!-- Data Grid -->
    <dx-data-grid
      *ngIf="!loading"
      [dataSource]="policyStats"
      [showBorders]="true"
      [columnAutoWidth]="true">
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
        [showPageSizeSelector]="true"
        [allowedPageSizes]="[5, 10, 20]"
        [showInfo]="true">
      </dxo-pager>

      <dxi-column dataField="policy_name" caption="Policy Name"></dxi-column>
      <dxi-column dataField="acknowledged_count" caption="Acknowledged" cellTemplate="acknowledgedTemplate" alignment="center"></dxi-column>
      <dxi-column dataField="pending_count" caption="Pending" cellTemplate="pendingTemplate" alignment="center"></dxi-column>
      <dxi-column dataField="acknowledgment_rate" caption="Compliance Rate" cellTemplate="rateTemplate" alignment="center"></dxi-column>
      <dxi-column dataField="created_at" caption="Created" dataType="date" format="dd/MM/yyyy"></dxi-column>
      <dxi-column caption="Actions" cellTemplate="actionsTemplate" alignment="center"></dxi-column>

      <!-- Acknowledged Template -->
      <div *dxTemplate="let data of 'acknowledgedTemplate'">
        <span class="count-badge acknowledged">
          {{ data.value }}
        </span>
      </div>

      <!-- Pending Template -->
      <div *dxTemplate="let data of 'pendingTemplate'">
        <span class="count-badge" [class]="data.value > 0 ? 'pending' : 'none'">
          {{ data.value }}
        </span>
      </div>

      <!-- Rate Template -->
      <div *dxTemplate="let data of 'rateTemplate'">
        <div class="rate-display">
          <span class="rate-text" [style.color]="getAcknowledmentRateColor(data.value)">
            {{ data.value }}%
          </span>
        </div>
      </div>

      <!-- Actions Template -->
      <div *dxTemplate="let data of 'actionsTemplate'">
        <div class="actions-cell">
          <dx-button
            icon="info"
            hint="View Details"
            stylingMode="text"
            (onClick)="openDetailsPopup(data.data)">
          </dx-button>
          
          <dx-button
            *ngIf="canManagePolicies()"
            icon="email"
            hint="Send Notifications"
            stylingMode="text"
            (onClick)="openNotificationForPolicy(data.data.policy_id)">
          </dx-button>
        </div>
      </div>

    </dx-data-grid>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loading && policyStats.length === 0">
      <div class="empty-icon">
        <i class="dx-icon-doc"></i>
      </div>
      <h3>No Policy Statistics Available</h3>
      <p>There are currently no policies with acknowledgment data.</p>
      <dx-button
        text="Reload Data"
        type="default"
        icon="refresh"
        (onClick)="refreshData()">
      </dx-button>
    </div>
  </div>
</div>

<!-- Send Notifications Popup -->
<dx-popup
  [visible]="notificationPopupVisible"
  [hideOnOutsideClick]="false"
  [showCloseButton]="true"
  [width]="500"
  [height]="400"
  title="Send Policy Notifications"
  (onHiding)="closeNotificationPopup()">
  
  <div *dxTemplate="let data of 'content'">
    <div class="notification-form" *ngIf="selectedPolicy">
      <div class="policy-info">
        <h3>{{ selectedPolicy.name }}</h3>
        <p *ngIf="selectedPolicy.description">{{ selectedPolicy.description }}</p>
      </div>
      
      <dx-form [formData]="notificationFormData" [colCount]="1">
        
        <dxi-item dataField="deadline_days" [isRequired]="true" editorType="dxNumberBox"
                  [editorOptions]="{
                    min: 1,
                    max: 30,
                    placeholder: 'Days to acknowledge'
                  }">
          <dxo-label text="Acknowledgment Deadline (Days)"></dxo-label>
        </dxi-item>
        
      </dx-form>
      
      <div class="notification-info">
        <p><strong>Note:</strong> Notifications will be sent to all users who have not yet acknowledged this policy.</p>
      </div>
      
      <!-- Action buttons -->
      <div class="popup-actions">
        <dx-button
          text="Cancel"
          stylingMode="outlined"
          (onClick)="closeNotificationPopup()">
        </dx-button>
        <dx-button
          text="Send Notifications"
          type="default"
          icon="email"
          (onClick)="sendNotifications()">
        </dx-button>
      </div>
    </div>
  </div>
</dx-popup>

<!-- Policy Details Popup -->
<dx-popup
  [visible]="detailsPopupVisible"
  [hideOnOutsideClick]="false"
  [showCloseButton]="true"
  [width]="900"
  [height]="700"
  [title]="'Policy Acknowledgment Details: ' + (selectedPolicyStats?.policy_name || '')"
  (onHiding)="closeDetailsPopup()">
  
  <div *dxTemplate="let data of 'content'">
    <div class="details-content" *ngIf="selectedPolicyStats">
      
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card acknowledged">
          <div class="card-icon">
            <i class="dx-icon-check"></i>
          </div>
          <div class="card-content">
            <div class="card-number">{{ selectedPolicyStats.acknowledged_count }}</div>
            <div class="card-label">Acknowledged</div>
          </div>
        </div>
        
        <div class="summary-card pending">
          <div class="card-icon">
            <i class="dx-icon-clock"></i>
          </div>
          <div class="card-content">
            <div class="card-number">{{ selectedPolicyStats.pending_count }}</div>
            <div class="card-label">Pending</div>
          </div>
        </div>
        
        <div class="summary-card overdue">
          <div class="card-icon">
            <i class="dx-icon-warning"></i>
          </div>
          <div class="card-content">
            <div class="card-number">{{ selectedPolicyStats.overdue_count }}</div>
            <div class="card-label">Overdue</div>
          </div>
        </div>
        
        <div class="summary-card rate">
          <div class="card-icon">
            <i class="dx-icon-percent"></i>
          </div>
          <div class="card-content">
            <div class="card-number">{{ selectedPolicyStats.acknowledgment_rate }}%</div>
            <div class="card-label">Compliance Rate</div>
          </div>
        </div>
      </div>
      
      <!-- Acknowledgment Details Grid -->
      <div class="details-grid">
        <dx-data-grid
          [dataSource]="acknowledgmentDetails"
          [showBorders]="true"
          [columnAutoWidth]="true">
          <dxo-paging [pageSize]="10"></dxo-paging>
          <dxo-pager
            [showPageSizeSelector]="true"
            [allowedPageSizes]="[5, 10, 20]"
            [showInfo]="true">
          </dxo-pager>

          <dxi-column dataField="user_name" caption="User"></dxi-column>
          <dxi-column dataField="user_email" caption="Email"></dxi-column>
          <dxi-column caption="Status" cellTemplate="userStatusTemplate" alignment="center"></dxi-column>
          <dxi-column dataField="acknowledged_at" caption="Acknowledged" dataType="date" format="dd/MM/yyyy" cellTemplate="acknowledgedDateTemplate"></dxi-column>

          <!-- User Status Template -->
          <div *dxTemplate="let data of 'userStatusTemplate'">
            <div class="status-cell">
              <i class="dx-icon-{{ getStatusIcon(data.data.is_acknowledged, isOverdue(data.data.acknowledgment_deadline)) }}"
                 [style.color]="getStatusColor(data.data.is_acknowledged, isOverdue(data.data.acknowledgment_deadline))"></i>
              <span [style.color]="getStatusColor(data.data.is_acknowledged, isOverdue(data.data.acknowledgment_deadline))"
                    class="status-text">
                {{ getStatusText(data.data.is_acknowledged, isOverdue(data.data.acknowledgment_deadline)) }}
              </span>
            </div>
          </div>

          <!-- Acknowledged Date Template -->
          <div *dxTemplate="let data of 'acknowledgedDateTemplate'">
            <span *ngIf="data.data.is_acknowledged && data.value">{{ formatDate(data.value) }}</span>
            <span *ngIf="!data.data.is_acknowledged" class="not-acknowledged">-</span>
          </div>

        </dx-data-grid>
      </div>
    </div>
  </div>
</dx-popup>

<!-- Toast Notification -->
<dx-toast
  [visible]="toastVisible"
  [message]="toastMessage"
  [type]="toastType"
  [displayTime]="4000"
  (onHiding)="toastVisible = false">
</dx-toast>
<div class="policies-container">
  <div class="page-header">
    <h2>Company Policies</h2>
    <p class="subtitle">Manage company policy documents</p>
    <div class="header-actions">
      <dx-button
        *ngIf="canManagePolicies()"
        text="Add Policy"
        type="default"
        icon="plus"
        (onClick)="openAddPolicyPopup()">
      </dx-button>
    </div>
  </div>

  <div class="content-section">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <dx-load-indicator [visible]="true"></dx-load-indicator>
      <p>Loading policies...</p>
    </div>

    <!-- Data Grid -->
    <dx-data-grid
      *ngIf="!loading"
      [dataSource]="policies"
      [showBorders]="true"
      [columnAutoWidth]="true">
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
        [showPageSizeSelector]="true"
        [allowedPageSizes]="[5, 10, 20]"
        [showInfo]="true">
      </dxo-pager>
      
      <dxi-column dataField="name" caption="Policy Name"></dxi-column>
      <dxi-column dataField="description" caption="Description" cellTemplate="descriptionTemplate"></dxi-column>
      <dxi-column dataField="file_name" caption="File"></dxi-column>
      <dxi-column dataField="created_at" caption="Created" dataType="date" format="dd/MM/yyyy"></dxi-column>
      <dxi-column caption="Actions" cellTemplate="actionsTemplate"></dxi-column>

      <!-- Description Template -->
      <div *dxTemplate="let data of 'descriptionTemplate'">
        <span class="description-text"
              [title]="data.value || 'No description'">
          {{ (data.value || 'No description') | slice:0:50 }}
          <span *ngIf="data.value && data.value.length > 50">...</span>
        </span>
      </div>

      <!-- Actions Template -->
      <div *dxTemplate="let data of 'actionsTemplate'">
        <div class="actions-cell">
          <dx-button
            icon="eyeopen"
            hint="View Document"
            stylingMode="text"
            (onClick)="viewPolicy(data.data)">
          </dx-button>
          
          <dx-button
            icon="download"
            hint="Download"
            stylingMode="text"
            (onClick)="downloadPolicy(data.data)">
          </dx-button>
          
          <dx-button
            *ngIf="canManagePolicies()"
            icon="edit"
            hint="Edit"
            stylingMode="text"
            (onClick)="openEditPolicyPopup(data.data)">
          </dx-button>
          
          <dx-button
            *ngIf="canDeletePolicy()"
            icon="trash"
            hint="Delete"
            stylingMode="text"
            (onClick)="deletePolicy(data.data)">
          </dx-button>
        </div>
      </div>

    </dx-data-grid>

    <!-- Empty State -->
    <div *ngIf="!loading && policies.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="dx-icon-doc"></i>
      </div>
      <h3>No Policies Found</h3>
      <p>There are currently no policies available.</p>
    </div>
  </div>
</div>

<!-- Add/Edit Policy Popup -->
<dx-popup
  [visible]="addEditPopupVisible"
  [hideOnOutsideClick]="false"
  [showCloseButton]="true"
  [width]="600"
  [height]="500"
  [title]="isEditMode ? 'Edit Policy' : 'Add New Policy'"
  (onHiding)="closeAddEditPopup()">
  
  <div *dxTemplate="let data of 'content'">
    <div class="policy-form">
      <dx-form [formData]="formData" [colCount]="1">
        
        <dxi-item dataField="name" [isRequired]="true">
          <dxo-label text="Policy Name"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="description" editorType="dxTextArea">
          <dxo-label text="Description"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="org_unit_id" editorType="dxSelectBox" 
                  [editorOptions]="{
                    dataSource: orgUnits,
                    displayExpr: 'name',
                    valueExpr: 'id',
                    placeholder: 'Select organization (optional)'
                  }">
          <dxo-label text="Organization"></dxo-label>
        </dxi-item>
        
      </dx-form>
      
      <!-- File Upload Section -->
      <div class="file-upload-section" *ngIf="!isEditMode">
        <label class="upload-label">Policy Document *</label>
        <dx-file-uploader
          [multiple]="false"
          [accept]="fileUploaderOptions.accept"
          [uploadMode]="fileUploaderOptions.uploadMode"
          [showFileList]="fileUploaderOptions.showFileList"
          [labelText]="fileUploaderOptions.labelText"
          [selectButtonText]="fileUploaderOptions.selectButtonText"
          (onValueChanged)="onFileSelected($event)">
        </dx-file-uploader>
        <div class="upload-help">
          Supported format: PDF only
        </div>
      </div>
      
      <div class="file-info-section" *ngIf="isEditMode && selectedPolicy">
        <label class="info-label">Current File</label>
        <div class="current-file-info">
          <i [class]="getFileIcon(selectedPolicy.file_type)" 
             [style.color]="getFileTypeColor(selectedPolicy.file_type)"></i>
          <span>{{ selectedPolicy.file_name }}</span>
          <span class="file-size" *ngIf="selectedPolicy.file_size">({{ selectedPolicy.file_size }})</span>
        </div>
        <div class="file-note">
          Note: To change the file, please delete this policy and create a new one.
        </div>
      </div>
      
      <!-- Action buttons -->
      <div class="popup-actions">
        <dx-button
          text="Cancel"
          stylingMode="outlined"
          (onClick)="closeAddEditPopup()">
        </dx-button>
        <dx-button
          [text]="saving ? (isEditMode ? 'Updating...' : 'Creating...') : (isEditMode ? 'Update Policy' : 'Create Policy')"
          type="default"
          [disabled]="saving"
          (onClick)="savePolicy()">
        </dx-button>
      </div>
    </div>
  </div>
</dx-popup>

<!-- Document Viewer -->
<app-document-viewer
  [visible]="documentViewerVisible"
  [documentUrl]="currentDocumentUrl"
  [documentName]="currentDocumentName"
  [fileType]="currentDocumentType"
  (onPopupHiding)="closeDocumentViewer()">
</app-document-viewer>

<!-- Toast Notification -->
<dx-toast
  [visible]="toastVisible"
  [message]="toastMessage"
  [type]="toastType"
  [displayTime]="4000"
  (onHiding)="toastVisible = false">
</dx-toast>
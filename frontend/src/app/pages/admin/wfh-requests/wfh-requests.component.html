<div class="wfh-requests-container">
  <div class="page-header">
    <h2>Work From Home Requests</h2>
    <p class="subtitle">Manage and approve work from home requests</p>
  </div>

  <!-- Status Filter Buttons -->
  <div class="filter-section">
    <div class="filter-buttons">
      <dx-button
        [text]="'All (' + getTotalCount() + ')'"
        [type]="selectedFilter === 'all' ? 'default' : 'normal'"
        stylingMode="contained"
        (onClick)="setFilter('all')">
      </dx-button>
      <dx-button
        [text]="'Pending (' + getStatusCount('pending') + ')'"
        [type]="selectedFilter === 'pending' ? 'default' : 'normal'"
        stylingMode="contained"
        [elementAttr]="{ class: 'filter-pending' }"
        (onClick)="setFilter('pending')">
      </dx-button>
      <dx-button
        [text]="'Approved (' + getStatusCount('approved') + ')'"
        [type]="selectedFilter === 'approved' ? 'default' : 'normal'"
        stylingMode="contained"
        [elementAttr]="{ class: 'filter-approved' }"
        (onClick)="setFilter('approved')">
      </dx-button>
      <dx-button
        [text]="'Rejected (' + getStatusCount('rejected') + ')'"
        [type]="selectedFilter === 'rejected' ? 'default' : 'normal'"
        stylingMode="contained"
        [elementAttr]="{ class: 'filter-rejected' }"
        (onClick)="setFilter('rejected')">
      </dx-button>
    </div>
  </div>

  <div class="content-section">
    <dx-data-grid
      [dataSource]="filteredWfhRequests"
      [showBorders]="true"
      [columnAutoWidth]="true"
      (onRowClick)="viewDetails($event)">
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
        [showPageSizeSelector]="true"
        [allowedPageSizes]="[5, 10, 20]"
        [showInfo]="true">
      </dxo-pager>

      <dxi-column dataField="employee_name" caption="Employee"></dxi-column>
      <dxi-column dataField="start_date" caption="Start Date" dataType="date" format="dd/MM/yyyy"></dxi-column>
      <dxi-column dataField="end_date" caption="End Date" dataType="date" format="dd/MM/yyyy"></dxi-column>
      <dxi-column caption="Working Days" cellTemplate="workingDaysTemplate"></dxi-column>
      <dxi-column dataField="status" caption="Status" cellTemplate="statusTemplate"></dxi-column>
      <dxi-column caption="Actions" cellTemplate="actionsTemplate"></dxi-column>

      <!-- Working Days Template -->
      <div *dxTemplate="let data of 'workingDaysTemplate'">
        <span class="working-days-badge">
          {{ calculateDays(data.data.start_date, data.data.end_date) }}
        </span>
      </div>

      <!-- Status Template -->
      <div *dxTemplate="let data of 'statusTemplate'">
        <div class="status-cell">
          <i class="dx-icon-{{ getStatusIcon(data.value) }}" 
             [style.color]="getStatusColor(data.value)"></i>
          <span [style.color]="getStatusColor(data.value)" 
                class="status-text">
            {{ data.value | titlecase }}
          </span>
        </div>
      </div>

      <!-- Reason Template -->
      <div *dxTemplate="let data of 'reasonTemplate'">
        <span class="reason-text" 
              [title]="data.value || 'No reason provided'">
          {{ (data.value || 'No reason provided') | slice:0:50 }}
          <span *ngIf="data.value && data.value.length > 50">...</span>
        </span>
      </div>

      <!-- Actions Template -->
      <div *dxTemplate="let data of 'actionsTemplate'">
        <div class="actions-cell">
          <dx-button
            icon="info"
            hint="View Details"
            stylingMode="text"
            (onClick)="viewDetails(data.data)">
          </dx-button>
          
          <dx-button
            *ngIf="canApproveReject(data.data)"
            icon="check"
            hint="Approve"
            stylingMode="text"
            [elementAttr]="{ class: 'approve-btn' }"
            (onClick)="approveRequest(data.data)">
          </dx-button>
          
          <dx-button
            *ngIf="canApproveReject(data.data)"
            icon="close"
            hint="Reject"
            stylingMode="text"
            [elementAttr]="{ class: 'reject-btn' }"
            (onClick)="rejectRequest(data.data)">
          </dx-button>
        </div>
      </div>

    </dx-data-grid>
  </div>
</div>

<!-- Details Popup -->
<dx-popup
  [visible]="detailsPopupVisible"
  [hideOnOutsideClick]="true"
  [showCloseButton]="true"
  [width]="600"
  [height]="500"
  title="WFH Request Details"
  (onHiding)="closeDetailsPopup()">
  
  <div *dxTemplate="let data of 'content'">
    <div class="request-details" *ngIf="selectedRequest">
      <dx-form [formData]="selectedRequest" [colCount]="2" [readOnly]="true">
        
        <dxi-item dataField="employee_name" [colSpan]="1">
          <dxo-label text="Employee Name"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="employee_email" [colSpan]="1">
          <dxo-label text="Email"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="start_date" [colSpan]="1" editorType="dxDateBox">
          <dxo-label text="Start Date"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="end_date" [colSpan]="1" editorType="dxDateBox">
          <dxo-label text="End Date"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="working_days" [colSpan]="1">
          <dxo-label text="Working Days"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="status" [colSpan]="1">
          <dxo-label text="Status"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="applied_at" [colSpan]="2" editorType="dxDateBox">
          <dxo-label text="Applied At"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="reason" [colSpan]="2" editorType="dxTextArea">
          <dxo-label text="Reason"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="decision_at" [colSpan]="1" editorType="dxDateBox" *ngIf="selectedRequest.decision_at">
          <dxo-label text="Decision At"></dxo-label>
        </dxi-item>
        
        <dxi-item dataField="approver_name" [colSpan]="1" *ngIf="selectedRequest.approver_name">
          <dxo-label text="Approved By"></dxo-label>
        </dxi-item>
        
      </dx-form>
      
      <!-- Action buttons in popup -->
      <div class="popup-actions" *ngIf="canApproveReject(selectedRequest)">
        <dx-button
          text="Approve"
          type="default"
          icon="check"
          (onClick)="approveRequest(selectedRequest); closeDetailsPopup()">
        </dx-button>
        <dx-button
          text="Reject"
          type="danger"
          icon="close"
          (onClick)="rejectRequest(selectedRequest); closeDetailsPopup()">
        </dx-button>
      </div>
    </div>
  </div>
</dx-popup>

<!-- Toast Notification -->
<dx-toast
  [visible]="toastVisible"
  [message]="toastMessage"
  [type]="toastType"
  [displayTime]="4000"
  (onHiding)="toastVisible = false">
</dx-toast>
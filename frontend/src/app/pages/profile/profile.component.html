<h2>Profile</h2>

<div class="content-block dx-card responsive-paddings profile-header">
  <div class="profile-header-content">
    <div class="form-avatar" [class.editable]="isEditing" (click)="isEditing && triggerFileInput()">
      <img 
        [src]="profileImageSrc"
        alt="Profile Image" 
        class="profile-image" 
        (error)="handleImageError($event)"
      />
      <div class="image-upload-overlay" *ngIf="isEditing">
        <span>Change Image</span>
        <i class="dx-icon-photo"></i>
      </div>
      <input type="file" #fileInput style="display: none" accept="image/*" (change)="handleFileInput($event)"/>
    </div>
    <div class="profile-info">
      <h4>{{ employee.name }}</h4>
      <p>{{ employee.role_title || employee.role_band }}</p>
    </div>
  </div>
  <div class="profile-actions">
    <dx-button
      *ngIf="!isEditing"
      text="Edit Profile"
      type="default"
      (onClick)="toggleEdit()"
      [disabled]="isLoading"
    ></dx-button>
    <ng-container *ngIf="isEditing">
      <dx-button
        [text]="isLoading ? 'Saving...' : 'Save'"
        type="success"
        (onClick)="saveChanges()"
        [disabled]="isLoading"
        class="action-button"
      >
        <div *dxTemplate="let data of 'content'">
          <span *ngIf="isLoading" class="loading-spinner"></span>
          <span>{{ isLoading ? 'Saving...' : 'Save' }}</span>
        </div>
      </dx-button>
      <dx-button
        text="Cancel"
        type="normal"
        (onClick)="toggleEdit()"
        [disabled]="isLoading"
        class="action-button"
      ></dx-button>
    </ng-container>
  </div>
</div>

<div class="content-block dx-card responsive-paddings">
  <dx-form id="form"
    [formData]="employee"
    labelLocation="top"
    [colCountByScreen]="colCountByScreen"
    [readOnly]="!isEditing"
  >
    <dxi-item dataField="name" [editorOptions]="{disabled: false}"></dxi-item>
    <dxi-item dataField="email" [editorOptions]="{disabled: true}"></dxi-item>
    <dxi-item dataField="passport_or_id_number" [editorOptions]="{disabled: false}"></dxi-item>
    <dxi-item dataField="role_band" [editorOptions]="{disabled: true}"></dxi-item>
    <dxi-item dataField="role_title" [editorOptions]="{disabled: true}"></dxi-item>
    <dxi-item dataField="gender" [editorOptions]="{disabled: true}"></dxi-item>
  </dx-form>
</div>

<!-- Password Change Section -->
<div class="content-block dx-card responsive-paddings">
  <div class="section-header">
    <h3>Change Password</h3>
  </div>
  
  <div *ngIf="passwordSuccessMessage" class="success-message">
    <p>{{ passwordSuccessMessage }}</p>
  </div>
  
  <div *ngIf="passwordErrorMessage" class="error-message">
    <p>{{ passwordErrorMessage }}</p>
  </div>
  
  <dx-form id="passwordForm"
    [formData]="passwordData"
    labelLocation="top"
    [colCountByScreen]="colCountByScreen"
    [disabled]="isChangingPassword"
  >
    <dxi-item dataField="currentPassword" editorType="dxTextBox" [editorOptions]="{mode: 'password'}">
      <dxi-validation-rule type="required" message="Current password is required"></dxi-validation-rule>
    </dxi-item>
    
    <dxi-item dataField="newPassword" editorType="dxTextBox" [editorOptions]="{mode: 'password'}">
      <dxi-validation-rule type="required" message="New password is required"></dxi-validation-rule>
      <dxi-validation-rule type="stringLength" [min]="8" message="Password must be at least 8 characters"></dxi-validation-rule>
      <dxi-validation-rule type="pattern" [pattern]="passwordPattern" message="Password must include at least one uppercase letter, one lowercase letter, one number, and one special character"></dxi-validation-rule>
    </dxi-item>
    
    <dxi-item dataField="confirmPassword" editorType="dxTextBox" [editorOptions]="{mode: 'password'}">
      <dxi-validation-rule type="required" message="Confirm password is required"></dxi-validation-rule>
      <dxi-validation-rule type="compare" [comparisonTarget]="getComparePassword" message="Passwords do not match"></dxi-validation-rule>
    </dxi-item>
  </dx-form>
  
  <div class="password-actions">
    <dx-button
      text="Change Password"
      type="default"
      (onClick)="changePassword()"
      [disabled]="isChangingPassword"
    ></dx-button>
  </div>
</div>

    <!-- Next of Kin Section -->
    <div class="content-block dx-card responsive-paddings">
      <div class="section-header">
        <h3>Emergency Contacts (Next of Kin)</h3>
        <p class="section-description">Manage your emergency contact information</p>
      </div>
      
      <!-- Success/Error Messages -->
      <div *ngIf="nextOfKinSuccessMessage" class="success-message">
        <p>{{ nextOfKinSuccessMessage }}</p>
      </div>
      
      <div *ngIf="nextOfKinErrorMessage" class="error-message">
        <p>{{ nextOfKinErrorMessage }}</p>
      </div>
      
      <!-- Next of Kin List -->
      <div *ngIf="!isEditingNextOfKin">
        <dx-data-grid
          *ngIf="nextOfKinContacts.length > 0"
          [dataSource]="nextOfKinContacts"
          [showBorders]="true"
          [columnAutoWidth]="true"
          [rowAlternationEnabled]="true"
        >
          <dxi-column dataField="full_name" caption="Name"></dxi-column>
          <dxi-column dataField="relationship" caption="Relationship"></dxi-column>
          <dxi-column dataField="phone_number" caption="Phone"></dxi-column>
          <dxi-column dataField="email" caption="Email"></dxi-column>
          <dxi-column dataField="address" caption="Address"></dxi-column>
          <dxi-column caption="Actions" cellTemplate="actionsTemplate" [width]="120"></dxi-column>
          
          <div *dxTemplate="let contact of 'actionsTemplate'">
            <div class="action-buttons">
              <dx-button
                icon="edit"
                type="default"
                [stylingMode]="'text'"
                (onClick)="editNextOfKin(contact.data)"
                [disabled]="isLoading"
                hint="Edit Contact"
              ></dx-button>
              <dx-button
                icon="trash"
                type="danger"
                [stylingMode]="'text'"
                (onClick)="deleteNextOfKin(contact.data)"
                [disabled]="isLoading"
                hint="Delete Contact"
              ></dx-button>
            </div>
          </div>
        </dx-data-grid>
        
        <div class="empty-state" *ngIf="nextOfKinContacts.length === 0">
          <i class="dx-icon-user"></i>
          <p>No emergency contacts added yet</p>
          <dx-button
            text="Add First Contact"
            type="default"
            icon="plus"
            (onClick)="toggleNextOfKinEdit()"
          ></dx-button>
        </div>
      </div>

      <!-- Next of Kin Form -->
      <div class="next-of-kin-form" *ngIf="isEditingNextOfKin">
        <dx-form
          [formData]="nextOfKinFormData"
          labelLocation="top"
          [colCountByScreen]="colCountByScreen"
        >
          <dxi-item dataField="relationship" editorType="dxSelectBox" 
                    [editorOptions]="{dataSource: relationshipOptions, placeholder: 'Select relationship'}">
            <dxi-validation-rule type="required" message="Relationship is required"></dxi-validation-rule>
          </dxi-item>
          
          <dxi-item dataField="full_name">
            <dxi-validation-rule type="required" message="Full name is required"></dxi-validation-rule>
          </dxi-item>
          
          <dxi-item dataField="phone_number">
            <dxi-validation-rule type="required" message="Phone number is required"></dxi-validation-rule>
            <dxi-validation-rule type="pattern" pattern="^[\+]?[1-9][\d]{0,15}$" message="Invalid phone number"></dxi-validation-rule>
          </dxi-item>
          
          <dxi-item dataField="email" editorType="dxTextBox">
            <dxi-validation-rule type="email" message="Invalid email address"></dxi-validation-rule>
          </dxi-item>
          
          <dxi-item dataField="address" editorType="dxTextArea" 
                    [editorOptions]="{height: 32, placeholder: 'Enter full address'}">
          </dxi-item>
          
          
          <dxi-item dataField="is_emergency_contact" editorType="dxCheckBox" 
                    [editorOptions]="{text: 'Use as emergency contact'}">
          </dxi-item>
        </dx-form>
        
        <div class="form-actions">
          <dx-button
            [text]="isCreatingNextOfKin ? 'Create Contact' : 'Update Contact'"
            type="success"
            (onClick)="isCreatingNextOfKin ? createNextOfKin() : updateNextOfKin()"
            [disabled]="isLoading"
          ></dx-button>
          <dx-button
            text="Cancel"
            type="normal"
            (onClick)="cancelNextOfKinEdit()"
            [disabled]="isLoading"
          ></dx-button>
        </div>
      </div>
      
      <!-- Add Contact Button (when not editing) -->
      <div class="add-contact-section" *ngIf="!isEditingNextOfKin && nextOfKinContacts.length > 0">
        <dx-button
          text="Add New Contact"
          type="default"
          icon="plus"
          (onClick)="toggleNextOfKinEdit()"
        ></dx-button>
      </div>
    </div>

<dx-file-uploader
  *ngIf="false"
  selectButtonText="Select Image"
  labelText=""
  accept="image/*"
  uploadMode="instantly"
  [uploadUrl]="uploadUrl"
  (onUploaded)="handleUploadedEvent($event)"
></dx-file-uploader>

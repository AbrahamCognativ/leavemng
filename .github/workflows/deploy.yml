name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: ${{ secrets.VM_PORT || 22 }}
        script: |
          # Navigate to project directory
          cd /leavemng
          
          # Pull latest code
          echo "Pulling latest code..."
          git pull origin main
          
          # Stop running containers
          echo "Stopping containers..."
          docker stop leavemng-backend leavemng-frontend || true
          
          # Remove containers
          echo "Removing containers..."
          docker rm leavemng-backend leavemng-frontend || true
          
          # Remove old images to force rebuild
          echo "Removing old images..."
          docker rmi leavemng-backend leavemng-frontend || true
          
          # Install docker-compose if not available and use it, otherwise use docker compose
          if ! command -v docker-compose &> /dev/null; then
            if ! docker compose version &> /dev/null; then
              echo "Installing docker-compose..."
              apt update && apt install -y docker-compose
            else
              echo "Using docker compose (without hyphen)..."
              docker compose down || true
              docker compose up -d --build --force-recreate
              exit 0
            fi
          fi
          
          # Use docker-compose
          echo "Using docker-compose..."
          docker-compose down || true
          docker-compose up -d --build --force-recreate
          
          # Verify deployment
          echo "Verifying deployment..."
          sleep 10
          docker ps
          
          # Check if containers are healthy
          if docker ps | grep -q "leavemng-backend.*Up" && docker ps | grep -q "leavemng-frontend.*Up"; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed - containers not running properly"
            docker logs leavemng-backend --tail 20
            docker logs leavemng-frontend --tail 20
            exit 1
          fi
